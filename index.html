<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ETS2 Vertical Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      background:#101217; 
      color:#e0e0e0; 
      font-family:sans-serif; 
      margin:0; 
      padding:20px; 
      display:flex; 
      flex-direction:column; 
      align-items:center;
    }
    h1 { 
      text-align:center; 
      color:#19ffd6; 
      margin-bottom:20px;
      font-size: 2em;
    }
    .kpi {
      background:#171a22;
      color:#19ffd6;
      padding:18px;
      border-radius:12px;
      margin:10px 0;
      width:90%;
      max-width:700px;
      text-align:center;
      font-size:1.3em;
      box-shadow:0 0 15px rgba(25,255,214,0.08);
      border: 1.5px solid #19ffd6;
      letter-spacing: 0.5px;
    }
    canvas { 
      background:#191d26; 
      border-radius:12px; 
      margin:15px 0; 
      padding:15px; 
      width:90% !important; 
      max-width:800px; 
      height:380px !important; 
      box-shadow:0 0 15px rgba(25,255,214,0.12);
      border: 1.5px solid #19ffd6;
    }
    table {
      width: 90%;
      max-width: 850px;
      border-collapse: collapse;
      margin-top: 30px;
      background: #171a22;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 16px rgba(25,255,214,0.14);
      margin-bottom:40px;
    }
    th, td {
      border: 1px solid #19ffd6;
      padding: 11px 10px;
      text-align: left;
      color: #19ffd6;
      font-size: 1.05em;
      background: #191d25;
    }
    th {
      background-color: #212230;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    tr:nth-child(even) td {
      background: #181924;
    }
    #map {
      margin-top: 40px;
      width: 90%;
      max-width: 900px;
      height: 400px;
      background: #101217;
      border-radius: 12px;
      box-shadow: 0 0 16px rgba(25,255,214,0.12);
      border: 2px solid #19ffd6;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #19ffd6;
      font-size: 1.2em;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>🚚 FRXGZ Ultimate Company Dashboard 🚚</h1>
  
  <div class="kpi" id="kpiTrucks">Loading trucks...</div>
  <div class="kpi" id="kpiDrivers">Loading drivers...</div>
  <div class="kpi" id="kpiIncome">Loading income...</div>
  <div class="kpi" id="kpiFuel">Loading fuel...</div>
  <div class="kpi" id="kpiGarages">Loading garages...</div>
  <div class="kpi" id="kpiTrailers">Loading trailers...</div>

  <canvas id="fuelChart"></canvas>
  <canvas id="repairsChart"></canvas>
  <canvas id="driverScoreChart"></canvas>
  <canvas id="incomeChart"></canvas>

  <h2 style="color:#19ffd6;margin-top:40px;">Past Jobs (Transactions)</h2>
  <table id="transactionsTable">
    <thead><tr id="transactionsHeader"></tr></thead>
    <tbody id="transactionsBody"></tbody>
  </table>

  <h2 style="color:#19ffd6;margin-top:40px;margin-bottom:10px;">Visited Countries Map</h2>
  <div id="map"></div>

  <script>
  // CSV URLs
  const trucksCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSq1GLbDENEZYWCjhdfY_lbazkfiEI6ISOffmP2QBOr_0gGAlRYaNc3uDQ22ZeHaaQa2UtOoXYDSYV2/pub?gid=146602917&single=true&output=csv";
  const driversCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSq1GLbDENEZYWCjhdfY_lbazkfiEI6ISOffmP2QBOr_0gGAlRYaNc3uDQ22ZeHaaQa2UtOoXYDSYV2/pub?gid=1310443753&single=true&output=csv";
  const garagesCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSq1GLbDENEZYWCjhdfY_lbazkfiEI6ISOffmP2QBOr_0gGAlRYaNc3uDQ22ZeHaaQa2UtOoXYDSYV2/pub?gid=1425443368&single=true&output=csv";
  const trailersCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSq1GLbDENEZYWCjhdfY_lbazkfiEI6ISOffmP2QBOr_0gGAlRYaNc3uDQ22ZeHaaQa2UtOoXYDSYV2/pub?gid=620180317&single=true&output=csv";
  const transactionsCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSq1GLbDENEZYWCjhdfY_lbazkfiEI6ISOffmP2QBOr_0gGAlRYaNc3uDQ22ZeHaaQa2UtOoXYDSYV2/pub?gid=726275393&single=true&output=csv";

  function formatEuro(val) {
    let n = parseFloat(val.replace(/[^\d.-]/g,"")) || 0;
    return "€" + n.toLocaleString();
  }
  function formatDistance(val) {
    let n = parseInt(val.replace(/[^\d]/g,"")) || 0;
    return n.toLocaleString() + " km";
  }

  async function loadCSV(url) {
    const resp = await fetch(url);
    const text = await resp.text();
    const lines = text.trim().split('\n');
    const headers = lines.shift().split(',');
    return lines.map(line => {
      const values = line.split(',');
      return headers.reduce((obj, header, idx) => {
        obj[header.trim()] = values[idx] ? values[idx].trim() : "";
        return obj;
      }, {});
    });
  }

  function renderTable(data, tableId, headerId, bodyId) {
    if (!data.length) return;

    const headers = Object.keys(data[0]);
    const headerRow = document.getElementById(headerId);
    const tbody = document.getElementById(bodyId);

    headerRow.innerHTML = "";
    tbody.innerHTML = "";

    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      headerRow.appendChild(th);
    });

    data.forEach(row => {
      const tr = document.createElement('tr');
      headers.forEach(h => {
        const td = document.createElement('td');
        let val = row[h] || "";
        if (h.toLowerCase().includes("revenue")) val = formatEuro(val);
        if (h.toLowerCase().includes("distance")) val = formatDistance(val);
        td.textContent = val;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  async function buildDashboard() {
    const [trucks, drivers, garages, trailers, transactions] = await Promise.all([
      loadCSV(trucksCSV),
      loadCSV(driversCSV),
      loadCSV(garagesCSV),
      loadCSV(trailersCSV),
      loadCSV(transactionsCSV)
    ]);

    // KPIs
    const totalIncome = trucks.reduce((sum, t) => sum + parseFloat(t["Monthly Income"] || 0), 0);
    const avgFuel = trucks.reduce((sum, t) => sum + parseFloat(t["Fuel L/100km"] || 0), 0) / (trucks.length || 1);

    document.getElementById("kpiTrucks").innerText = `🚚 Total Trucks: ${trucks.length}`;
    document.getElementById("kpiDrivers").innerText = `👨‍✈️ Total Drivers: ${drivers.length}`;
    document.getElementById("kpiIncome").innerText = `💰 Monthly Income: €${totalIncome.toLocaleString()}`;
    document.getElementById("kpiFuel").innerText = `⛽ Avg Fuel Consumption: ${avgFuel.toFixed(2)} L/100km`;
    document.getElementById("kpiGarages").innerText = `🏢 Garages: ${garages.length}`;
    document.getElementById("kpiTrailers").innerText = `🚛 Trailers: ${trailers.length}`;

    // Charts data
    const labels = trucks.map((t, i) => `${t["Model"]} #${i+1}`);
    const fuelCosts = trucks.map(t => parseFloat(t["Est Monthly Fuel Cost"] || 0));
    const repairs = trucks.map(t => parseFloat(t["Repair / 12 (avg monthly)"] || 0));
    const income = trucks.map(t => parseFloat(t["Monthly Income"] || 0));

    const axisColor = "#19ffd6";

    new Chart(document.getElementById("fuelChart"), {
      type: "bar",
      data: { labels, datasets: [{ label: "Fuel (€)", data: fuelCosts, backgroundColor: "#3ed6ff", borderColor: "#19ffd6", borderWidth: 2 }] },
      options: { 
        plugins: { legend: { labels: { color: axisColor } } }, 
        scales: { 
          x: { ticks: { color: axisColor }, grid: { color: "#2e3540" } }, 
          y: { beginAtZero:true, ticks:{ color: axisColor }, grid:{ color: "#2e3540" } }
        }, 
        backgroundColor: "#212230"
      }
    });

    new Chart(document.getElementById("repairsChart"), {
      type: "bar",
      data: { labels, datasets: [{ label: "Repairs (€)", data: repairs, backgroundColor: "#ffe066", borderColor:"#ffd700", borderWidth:2 }] },
      options: { 
        plugins: { legend: { labels: { color: axisColor } } }, 
        scales: { x: { ticks: { color: axisColor }, grid: { color: "#2e3540" } }, y: { beginAtZero:true, ticks: { color: axisColor }, grid: { color: "#2e3540" } } }
      }
    });

    new Chart(document.getElementById("driverScoreChart"), {
      type: "radar",
      data: {
        labels: drivers.map(d => d["Name"]),
        datasets: [{
          label: "Driver Score",
          data: drivers.map(d => parseFloat(d["Driver Score (0-100)"] || 0)),
          borderColor: "#ffe066",
          backgroundColor: "rgba(255, 224, 102,0.25)"
        }]
      },
      options: { 
        plugins: { legend: { labels: { color: axisColor } } }, 
        scales: { r: { pointLabels: { color: axisColor }, angleLines: { color: axisColor }, grid:{ color: "#2e3540" }, ticks:{ color: axisColor } } } 
      }
    });

    new Chart(document.getElementById("incomeChart"), {
      type: "line",
      data: { labels, datasets: [{ label: "Monthly Income (€)", data: income, borderColor: "#19ffd6", backgroundColor: "rgba(25,255,214,0.16)" }] },
      options: { 
        plugins: { legend: { labels: { color: axisColor } } }, 
        scales: { x: { ticks: { color: axisColor }, grid: { color: "#2e3540" } }, y: { beginAtZero:true, ticks: { color: axisColor }, grid: { color: "#2e3540" } } }
      }
    });

    renderTable(transactions, 'transactionsTable', 'transactionsHeader', 'transactionsBody');
  }

  buildDashboard();
  </script>
</body>
</html>
